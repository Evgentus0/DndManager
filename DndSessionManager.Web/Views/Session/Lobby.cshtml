@{
	ViewData["Title"] = "Lobby";
	var session = ViewBag.Session as DndSessionManager.Web.Models.Session;
	var currentUser = ViewBag.CurrentUser as DndSessionManager.Web.Models.User;
	var currentCharacter = ViewBag.CurrentCharacter as DndSessionManager.Web.Models.Character;
	var isMaster = ViewBag.IsMaster;
}

@section Styles {
	<link rel="stylesheet" href="~/css/markdownEditorPanel.css" asp-append-version="true" />
}

<div id="lobby-app" class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h2>{{ sessionName }}</h2>
            <p class="text-muted mb-0">Session ID: {{ sessionId }}</p>
            <span class="badge" :class="sessionOpen ? 'bg-info' : 'bg-secondary'">
                {{ sessionOpen ? $t('lobby.status.open') : $t('lobby.status.closed') }}
            </span>
        </div>
        <div class="col-auto">
            <form id="leave-form" asp-controller="Session" asp-action="Leave" asp-route-id="@session?.Id" method="post" class="d-inline">
                <button type="submit" class="btn btn-danger">{{ $t('lobby.buttons.leave') }}</button>
            </form>
        </div>
    </div>

    <div class="row">
        <!-- User List Panel -->
        <div class="col-12 col-lg-3 mb-3">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">{{ $t('lobby.players.title') }} ({{ users.length }}/{{ maxPlayers }})</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        <div v-for="user in users" :key="user.id"
                             class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ user.username }}</strong>
                                <span v-if="user.role === 'Master'" class="badge bg-danger ms-2">
                                    {{ $t('lobby.players.master') }}
                                </span>
                                <span v-else class="badge bg-primary ms-2">
                                    {{ $t('lobby.players.player') }}
                                </span>
                            </div>
                            <button v-if="canKick(user)"
                                    @@click="kickUser(user.id)"
                                    class="btn btn-sm btn-danger">
                                {{ $t('lobby.players.kick') }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Master Controls -->
            <div v-if="isMaster" class="card shadow-sm mt-3">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">{{ $t('lobby.master.title') }}</h5>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="toggleOpen"
                               v-model="sessionOpen" @@change="toggleSessionOpen">
                        <label class="form-check-label" for="toggleOpen">
                            {{ $t('lobby.master.openToggle') }}
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activities Panel -->
        <div class="col-12 col-lg-9">
            <!-- Tabs Navigation -->
            <ul class="nav nav-tabs mb-3">
                <li class="nav-item">
                    <a class="nav-link" :class="{ active: activeTab === 'chat' }"
                       href="#" @@click.prevent="activeTab = 'chat'">
                        {{ $t('lobby.tabs.chat') }}
                    </a>
                </li>
                <li v-if="!isMaster" class="nav-item">
                    <a class="nav-link" :class="{ active: activeTab === 'myCharacter' }"
                       href="#" @@click.prevent="activeTab = 'myCharacter'">
                        {{ $t('lobby.tabs.myCharacter') }}
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" :class="{ active: activeTab === 'characters' }"
                       href="#" @@click.prevent="activeTab = 'characters'">
                        {{ $t('lobby.tabs.characters') }}
                    </a>
                </li>
				<li v-if="!isMaster && characterId" class="nav-item">
                    <a class="nav-link" :class="{ active: activeTab === 'myNotes' }"
                       href="#" @@click.prevent="activeTab = 'myNotes'">
                        {{ $t('lobby.tabs.myNotes') }}
                    </a>
                </li>
                <li v-if="isMaster" class="nav-item">
                    <a class="nav-link" :class="{ active: activeTab === 'masterNotes' }"
                       href="#" @@click.prevent="activeTab = 'masterNotes'">
                        {{ $t('lobby.tabs.masterNotes') }}
                    </a>
                </li>
            </ul>

            <!-- Tab Content -->
            <lobby-chat-panel
                v-show="activeTab === 'chat'"
                ref="chatPanelRef"
                :connection="connection"
                :session-id="sessionId"
                :user-id="userId">
            </lobby-chat-panel>

            <lobby-my-character-panel
                v-if="!isMaster"
                v-show="activeTab === 'myCharacter'"
                :connection="connection"
                :session-id="sessionId"
                :user-id="userId">
            </lobby-my-character-panel>

            <lobby-character-panel
                v-show="activeTab === 'characters'"
                :connection="connection"
                :session-id="sessionId"
                :user-id="userId"
                :is-master="isMaster"
                :users="users">
            </lobby-character-panel>

            <lobby-character-notes-panel
                v-if="!isMaster && characterId"
                v-show="activeTab === 'myNotes'"
                :connection="connection"
                :session-id="sessionId"
                :user-id="userId"
                :character-id="characterId">
            </lobby-character-notes-panel>

            <lobby-master-notes-panel
                v-if="isMaster"
                v-show="activeTab === 'masterNotes'"
                :connection="connection"
                :session-id="sessionId"
                :user-id="userId">
            </lobby-master-notes-panel>
        </div>
    </div>
</div>

@section Scripts {
	<script type="module">
		import { createApp, ref, computed, shallowRef } from 'vue'
		import { useI18n } from 'vue-i18n'
		import { i18n } from '/ClientApp/i18n.js'
		import { useCharacterData } from '/ClientApp/composables/useCharacterData.js'
		import LobbyChatPanel from '/ClientApp/components/LobbyChatPanel.js'
		import LobbyCharacterPanel from '/ClientApp/components/LobbyCharacterPanel.js'
		import LobbyMyCharacterPanel from '/ClientApp/components/LobbyMyCharacterPanel.js'
		import LobbyMasterNotesPanel from '/ClientApp/components/LobbyMasterNotesPanel.js'
		import LobbyCharacterNotesPanel from '/ClientApp/components/LobbyCharacterNotesPanel.js'
		import MarkdownEditorPanel from '/ClientApp/components/MarkdownEditorPanel.js'

		const app = createApp({
			components: {
				LobbyChatPanel,
				LobbyCharacterPanel,
				LobbyMyCharacterPanel,
				LobbyMasterNotesPanel,
				LobbyCharacterNotesPanel,
				MarkdownEditorPanel
			},
			setup() {
				const { t } = useI18n()

				// Session data
				const sessionId = '@session?.Id';
				const userId = '@currentUser?.Id';
				const characterId = '@currentCharacter?.Id';
				const sessionName = '@Html.Raw(session?.Name)'
				const isMaster = @Json.Serialize(isMaster);
				const maxPlayers = @(session?.MaxPlayers ?? 0);

				// Reactive state
				const users = ref(@Html.Raw(Json.Serialize(session?.Users)))
				const sessionOpen = ref(@Json.Serialize(session?.IsOpen))
				const activeTab = ref('chat')
				const connection = shallowRef(null)
				const chatPanelRef = ref(null)

				// Computed
				const canKick = computed(() => {
					return (user) => isMaster && user.role !== 'Master' && user.id !== userId
				})

				// Methods
				async function toggleSessionOpen() {
					try {
						await connection.value.invoke('ToggleSessionOpen', sessionId, userId, sessionOpen.value);
					} catch (err) {
						console.error('Error toggling session open:', err)
					}
				}

				async function kickUser(kickedUserId) {
					if (confirm(t('lobby.master.kickConfirm'))) {
						try {
							await connection.value.invoke('KickUser', sessionId, userId, kickedUserId)
						} catch (err) {
							console.error('Error kicking user:', err)
						}
					}
				}

				function addSystemMessageToChat(message) {
					if (chatPanelRef.value) {
						chatPanelRef.value.addSystemMessage(message)
					}
				}

				async function initializeSignalR() {
					connection.value = new signalR.HubConnectionBuilder()
						.withUrl('/lobbyHub')
						.withAutomaticReconnect()
						.build()

					// Event handlers for user management (stay in parent)
					connection.value.on('InitialUserList', (usersList) => {
						users.value = usersList
					})

					connection.value.on('UserJoined', (user) => {
						const existingIndex = users.value.findIndex(u => u.id === user.id)
						if (existingIndex === -1) {
							users.value.push(user)
							addSystemMessageToChat(t('lobby.messages.userJoined', { username: user.username }))
						}
					})

					connection.value.on('UserLeft', (data) => {
						users.value = users.value.filter(u => u.id !== data.id)
						addSystemMessageToChat(t('lobby.messages.userLeft', { username: data.username }))
					})

					connection.value.on('UserDisconnected', (data) => {
						addSystemMessageToChat(t('lobby.messages.userDisconnected', { username: data.username }))
					})

					connection.value.on('UserKicked', () => {
						alert(t('lobby.messages.kicked'))
						submitLeaveForm({ id: sessionId })
					})

					connection.value.on('MasterLeave', () => {
						alert(t('lobby.messages.masterLeave'))
						submitLeaveForm({ id: sessionId })
					})

					connection.value.on('SessionOpenChanged', (isOpen) => {
						sessionOpen.value = isOpen
					})

					connection.value.onreconnecting(() => {
						addSystemMessageToChat(t('lobby.messages.connectionLost'))
					})

					connection.value.onreconnected(() => {
						addSystemMessageToChat(t('lobby.messages.reconnected'))
						connection.value.invoke('JoinLobby', sessionId, userId)
					})

					connection.value.onclose(() => {
						addSystemMessageToChat(t('lobby.messages.connectionClosed'));
					})

					try {
						await connection.value.start()
						await connection.value.invoke('JoinLobby', sessionId, userId)

					} catch (err) {
						console.error('SignalR connection error:', err)
					}
				}

				// simulate leave form sumbit
				function submitLeaveForm(data) {
					const form = document.createElement('form');
					form.method = 'POST';
					form.action = '/session/leave';
					if (data) {
						Object.keys(data).forEach(key => {
							const input = document.createElement('input');
							input.type = 'hidden';
							input.name = key;
							input.value = data[key];
							form.appendChild(input);
						});
					}
					document.body.appendChild(form);
					form.submit();
				}

				initializeSignalR();

				return {
					sessionId,
					userId,
					characterId,
					sessionName,
					isMaster,
					maxPlayers,
					users,
					sessionOpen,
					activeTab,
					connection,
					chatPanelRef,
					canKick,
					toggleSessionOpen,
					kickUser
				}
			}
		})

		app.use(i18n)
		app.mount('#lobby-app')
	</script>
}
