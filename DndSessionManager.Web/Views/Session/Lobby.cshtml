@{
    ViewData["Title"] = "Lobby";
    var session = ViewBag.Session as DndSessionManager.Web.Models.Session;
    var currentUser = ViewBag.CurrentUser as DndSessionManager.Web.Models.User;
    var isMaster = ViewBag.IsMaster;
}

<div id="lobby-app" class="container-fluid">
    <div class="row mb-3">
        <div class="col">
            <h2>{{ sessionName }}</h2>
            <p class="text-muted mb-0">Session ID: {{ sessionId }}</p>
            <span class="badge" :class="sessionOpen ? 'bg-info' : 'bg-secondary'">
                {{ sessionOpen ? $t('lobby.status.open') : $t('lobby.status.closed') }}
            </span>
        </div>
        <div class="col-auto">
            <form asp-controller="Session" asp-action="Leave" asp-route-id="@session.Id" method="post" class="d-inline">
                <button type="submit" class="btn btn-danger">{{ $t('lobby.buttons.leave') }}</button>
            </form>
        </div>
    </div>

    <div class="row">
        <!-- User List Panel -->
        <div class="col-12 col-lg-4 mb-3">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">{{ $t('lobby.players.title') }} ({{ users.length }}/{{ maxPlayers }})</h5>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        <div v-for="user in users" :key="user.id"
                             class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ user.username }}</strong>
                                <span v-if="user.role === 'Master'" class="badge bg-danger ms-2">
                                    {{ $t('lobby.players.master') }}
                                </span>
                                <span v-else class="badge bg-primary ms-2">
                                    {{ $t('lobby.players.player') }}
                                </span>
                            </div>
                            <button v-if="canKick(user)"
                                    @@click="kickUser(user.id)"
                                    class="btn btn-sm btn-danger">
                                {{ $t('lobby.players.kick') }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Master Controls -->
            <div v-if="isMaster" class="card shadow-sm mt-3">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">{{ $t('lobby.master.title') }}</h5>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="toggleOpen"
                               v-model="sessionOpen" @@change="toggleSessionOpen">
                        <label class="form-check-label" for="toggleOpen">
                            {{ $t('lobby.master.openToggle') }}
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Panel -->
        <div class="col-12 col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">{{ $t('lobby.chat.title') }}</h5>
                </div>
                <div class="card-body p-0">
                    <div ref="chatMessages" class="chat-messages p-3">
                        <div v-if="chatHistory.length === 0" class="text-muted text-center">
                            <small>{{ $t('lobby.chat.placeholder') }}</small>
                        </div>
                        <div v-for="(message, index) in chatHistory" :key="index" class="chat-message mb-2">
                            <div v-if="message.isSystem" class="text-muted fst-italic">
                                <small>{{ message.text }}</small>
                            </div>
                            <div v-else>
                                <strong>{{ message.username }}:</strong>
                                <span class="ms-2">{{ message.text }}</span>
                                <small class="text-muted ms-2">{{ formatTime(message.timestamp) }}</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="input-group">
                        <input type="text" class="form-control" v-model="chatInput"
                               :placeholder="$t('lobby.chat.input')" maxlength="500"
                               @@keyup.enter="sendMessage">
                        <button class="btn btn-primary" type="button"
                                :disabled="!chatInput.trim()"
                                @@click="sendMessage">
                            {{ $t('lobby.chat.sendButton') }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
	<script type="module">
		import { createApp, ref, computed, nextTick } from 'vue'
		import { useI18n } from 'vue-i18n'
		import { i18n } from '/ClientApp/i18n.js'

		const app = createApp({
			setup() {
				const { t } = useI18n()

				// Session data
				const sessionId = '@session.Id'
				const userId = '@currentUser.Id'
				const sessionName = '@Html.Raw(session.Name)'
				const isMaster = @Json.Serialize(isMaster)
				const maxPlayers = @session.MaxPlayers

				// Reactive state
				const users = ref(@Html.Raw(Json.Serialize(session.Users)))
				const chatHistory = ref([])
				const chatInput = ref('')
				const sessionOpen = ref(@Json.Serialize(session.IsOpen))
				const chatMessages = ref(null)
				let connection = null

				// Computed
				const canKick = computed(() => {
					return (user) => isMaster && user.role !== 'Master' && user.id !== userId
				})

				// Methods
				function formatTime(timestamp) {
					const date = new Date(timestamp)
					return date.toLocaleTimeString()
				}

				function addSystemMessage(message) {
					chatHistory.value.push({
						text: message,
						timestamp: new Date().toISOString(),
						isSystem: true
					})
					scrollToBottom()
				}

				function addChatMessage(username, message, timestamp) {
					chatHistory.value.push({
						username,
						text: message,
						timestamp,
						isSystem: false
					})
					scrollToBottom()
				}

				async function scrollToBottom() {
					await nextTick()
					if (chatMessages.value) {
						chatMessages.value.scrollTop = chatMessages.value.scrollHeight
					}
				}

				async function sendMessage() {
					if (chatInput.value.trim()) {
						try {
							await connection.invoke('SendMessage', sessionId, userId, chatInput.value)
							chatInput.value = ''
						} catch (err) {
							console.error('Error sending message:', err)
						}
					}
				}

				async function toggleSessionOpen() {
					try {
						await connection.invoke('ToggleSessionOpen', sessionId, userId, sessionOpen.value);
					} catch (err) {
						console.error('Error toggling session open:', err)
					}
				}

				async function kickUser(kickedUserId) {
					if (confirm(t('lobby.master.kickConfirm'))) {
						try {
							await connection.invoke('KickUser', sessionId, userId, kickedUserId)
						} catch (err) {
							console.error('Error kicking user:', err)
						}
					}
				}

				async function initializeSignalR() {
					connection = new signalR.HubConnectionBuilder()
						.withUrl('/lobbyHub')
						.withAutomaticReconnect()
						.build()

					// Event handlers
					connection.on('InitialUserList', (usersList) => {
						users.value = usersList
					})

					connection.on('UserJoined', (user) => {
						const existingIndex = users.value.findIndex(u => u.id === user.id)
						if (existingIndex === -1) {
							users.value.push(user)
							addSystemMessage(t('lobby.messages.userJoined', { username: user.username }))
						}
					})

					connection.on('UserLeft', (data) => {
						users.value = users.value.filter(u => u.id !== data.id)
						addSystemMessage(t('lobby.messages.userLeft', { username: data.username }))
					})

					connection.on('UserDisconnected', (data) => {
						addSystemMessage(t('lobby.messages.userDisconnected', { username: data.username }))
					})

					connection.on('ReceiveMessage', (data) => {
						addChatMessage(data.username, data.message, data.timestamp)
					})

					connection.on('ChatHistory', (messages) => {
						chatHistory.value = messages.map(msg => ({
							username: msg.username,
							text: msg.message,
							timestamp: msg.timestamp,
							isSystem: false
						}))
						scrollToBottom()
					})

					connection.on('UserKicked', () => {
						alert(t('lobby.messages.kicked'))
						window.location.href = '/'
					})

					connection.on('SessionOpenChanged', (isOpen) => {
						sessionOpen.value = isOpen
					})

					connection.onreconnecting(() => {
						addSystemMessage(t('lobby.messages.connectionLost'))
					})

					connection.onreconnected(() => {
						addSystemMessage(t('lobby.messages.reconnected'))
						connection.invoke('JoinLobby', sessionId, userId)
					})

					connection.onclose(() => {
						addSystemMessage(t('lobby.messages.connectionClosed'))
					})

					try {
						await connection.start()
						await connection.invoke('JoinLobby', sessionId, userId)
					} catch (err) {
						console.error('SignalR connection error:', err)
					}
				}

				// Initialize on mount
				initializeSignalR()

				return {
					sessionId,
					userId,
					sessionName,
					isMaster,
					maxPlayers,
					users,
					chatHistory,
					chatInput,
					sessionOpen,
					chatMessages,
					canKick,
					formatTime,
					sendMessage,
					toggleSessionOpen,
					kickUser
				}
			}
		})

		app.use(i18n)
		app.mount('#lobby-app')
	</script>
}
