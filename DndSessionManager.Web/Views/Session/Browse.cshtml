@model IEnumerable<DndSessionManager.Web.Models.Session>

@{
    ViewData["Title"] = "Browse Sessions";
}

<div id="browse-app" class="container">
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-5">{{ $t('browse.title') }}</h1>
            <p class="text-muted">{{ $t('browse.subtitle') }}</p>
        </div>
        <div class="col-auto">
            <a asp-controller="Home" asp-action="Index" class="btn btn-secondary">{{ $t('browse.backButton') }}</a>
        </div>
    </div>

    <div v-if="sessions.length === 0" class="alert alert-info" role="alert">
        <h4 class="alert-heading">{{ $t('browse.empty.title') }}</h4>
        <p>{{ $t('browse.empty.message') }}</p>
        <hr>
        <a asp-controller="Session" asp-action="Create" class="btn btn-primary">{{ $t('browse.empty.button') }}</a>
    </div>

    <div v-else class="row">
        <div v-for="session in sessions" :key="session.id" class="col-12 col-md-6 col-lg-4 mb-4">
            <div class="card h-100 shadow-sm" :class="{ 'border-warning': session.state === 1 }">
                <div class="card-body">
                    <h5 class="card-title">{{ session.name }}</h5>
                    <p v-if="session.description" class="card-text text-muted small">{{ session.description }}</p>
                    <p v-else class="card-text text-muted small fst-italic">{{ $t('browse.card.noDescription') }}</p>

                    <div class="mb-2">
                        <!-- Saved session badge -->
                        <span v-if="session.state === 1" class="badge bg-warning text-dark">
                            {{ $t('browse.card.saved') }}
                        </span>
                        <!-- Active session badges -->
                        <span v-else class="badge bg-success">
                            {{ $t('browse.card.active') }}
                        </span>
                        <span v-if="session.state === 0" class="badge bg-info">
                            {{ session.users.length }} / {{ session.maxPlayers }} {{ $t('browse.card.players') }}
                        </span>
                        <span v-if="session.passwordHash" class="badge bg-secondary">
                            <i class="bi bi-lock-fill"></i>
                        </span>
                        <span v-if="session.state === 0 && !session.isOpen" class="badge bg-danger">
                            {{ $t('browse.card.closed') }}
                        </span>
                    </div>

                    <p class="card-text small text-muted">
                        <template v-if="session.state === 1 && session.lastPlayedAt">
                            {{ $t('browse.card.lastPlayed') }} {{ formatDate(session.lastPlayedAt) }}
                        </template>
                        <template v-else>
                            {{ $t('browse.card.created') }} {{ formatDate(session.createdAt) }}
                        </template>
                    </p>
                    <p v-if="session.masterUsername" class="card-text small text-muted">
                        <i class="bi bi-person-fill"></i> {{ session.masterUsername }}
                    </p>
                </div>
                <div class="card-footer">
                    <!-- Saved session: Resume button -->
                    <template v-if="session.state === 1">
                        <a :href="`/Session/Resume/${session.id}`" class="btn btn-warning w-100">
                            {{ $t('browse.card.resumeButton') }}
                        </a>
                    </template>
                    <!-- Active session: Join/Closed/Full buttons -->
                    <template v-else>
                        <a v-if="session.isOpen && session.users.length < session.maxPlayers"
                           :href="`/Session/Join/${session.id}`"
                           class="btn btn-success w-100">
                            {{ $t('browse.card.joinButton') }}
                        </a>
                        <button v-else-if="!session.isOpen"
                                class="btn btn-secondary w-100"
                                disabled>
                            {{ $t('browse.card.closedButton') }}
                        </button>
                        <button v-else
                                class="btn btn-secondary w-100"
                                disabled>
                            {{ $t('browse.card.fullButton') }}
                        </button>
                    </template>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
	<script type="module">
		import { createApp, ref } from 'vue'
		import { useI18n } from 'vue-i18n'
		import { i18n } from '/ClientApp/i18n.js'

		const app = createApp({
			setup() {
				const { t, locale } = useI18n()

				// Reactive state
				const sessions = ref(@Html.Raw(Json.Serialize(Model)));
				let connection = null;

				function formatDate(dateString) {
					if (!dateString) return ''
					const date = new Date(dateString)
					return date.toLocaleString(locale.value)
				}
				async function initializeSignalR() {
					connection = new signalR.HubConnectionBuilder()
						.withUrl('/browseHub')
						.withAutomaticReconnect()
						.build();

					connection.on('ReceiveAvailableSessionsList', (sessionList) => {
						sessions.value = sessionList
					});

					try {
						await connection.start()
					} catch (err) {
						console.error('SignalR connection error:', err)
					}
				}

				// Initialize on mount
				initializeSignalR();

				return {
					formatDate,
					sessions
				}
			}
		})

		app.use(i18n)
		app.mount('#browse-app')
	</script>
}
